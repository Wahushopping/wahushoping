<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - WahuShop</title>
  <link rel="stylesheet" href="cart.css" />
</head>
<body>
  <header>
    <div class="logo">
      <img src="image/WhatsApp Image 2025-07-30 at 22.14.43_da49cc2e.jpg" style="width: 100px; padding-top: 7px; border-radius:5px; padding-left: 20px;">
    </div>
  </header>

  <main class="checkout-container" style="max-width: 500px; margin: auto; padding: 20px;">
    <h2>Confirm Your Order</h2>

    <!-- Address -->
    <section id="addressSection" style="margin-bottom: 20px;">
      <h3>Shipping Address</h3>
      <div id="addressInfo" style="background: #f0f0f0; padding: 10px; border-radius: 5px;"></div>
      <button onclick="window.location.href='profile.html'" style="margin-top: 10px;">Change Address</button>
    </section>

    <!-- Order Items -->
    <section id="orderItems" style="margin-bottom: 20px;"></section>

    <!-- Price Summary -->
    <section>
      <h3>Price Details</h3>
      <p>Total: ₹<span id="total"></span></p>
      <p>Discount: ₹<span id="discount"></span></p>
      <p><strong>Payable: ₹<span id="payable"></span></strong></p>
    </section>

    <!-- Payment Method -->
    <section style="margin: 20px 0;">
      <h3>Select Payment Method</h3>
      <label><input type="radio" name="payment" value="cod" checked /> Cash on Delivery</label><br />
      <label><input type="radio" name="payment" value="upi" /> UPI</label>
    </section>

    <!-- Place Order Button -->
    <button onclick="placeOrder()" style="width: 100%; padding: 12px; background: green; color: white; font-size: 18px; border: none; border-radius: 5px;">Place Order</button>

    <div id="orderStatus" style="margin-top: 15px; color: green;"></div>
  </main>

  <script>
    const checkoutData = JSON.parse(sessionStorage.getItem("checkoutData") || "{}");
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const addressInfo = document.getElementById("addressInfo");
    const orderItems = document.getElementById("orderItems");

    if (!checkoutData.cart || checkoutData.cart.length === 0) {
      alert("Your cart is empty!");
      window.location.href = "cart.html";
    }

    // Display address
    if (user && user.address && user.address.city) {
      const a = user.address;
      addressInfo.innerHTML = `
        ${a.name || ""}<br>
        ${a.street || ""} ${a.road || ""}, ${a.place || ""}<br>
        ${a.city}, ${a.state} - ${a.pincode}<br>
        Phone: ${a.phone}
      `;
    } else {
      addressInfo.innerHTML = `<span style="color: red;">No address found.</span>`;
    }

    // Display cart items
    checkoutData.cart.forEach(item => {
      const div = document.createElement("div");
      div.style.borderBottom = "1px solid #ccc";
      div.style.padding = "10px 0";
      div.innerHTML = `
        <strong>${item.name}</strong><br/>
        Size: ${item.size} | Qty: ${item.qty} <br/>
        Price: ₹${item.price} | Subtotal: ₹${item.qty * item.price}
      `;
      orderItems.appendChild(div);
    });

    // Price info
    document.getElementById("total").textContent = checkoutData.total;
    document.getElementById("discount").textContent = checkoutData.discount;
    document.getElementById("payable").textContent = checkoutData.finalAmount;

   function placeCODOrder(paymentId = null) {
  const a = user.address;
  const fullAddress = `${a.street || ""}${a.road ? ", " + a.road : ""}${a.place ? ", " + a.place : ""}, ${a.city}, ${a.state} - ${a.pincode}`;

  const orderData = {
    items: checkoutData.cart,
    total: checkoutData.total,
    discount: checkoutData.discount,
    finalAmount: checkoutData.finalAmount,
    paymentMethod: paymentId ? "UPI" : "COD",
    address: {
      ...a,
      fullAddress
    },
    razorpayPaymentId: paymentId
  };

  fetch("http://localhost:5000/api/orders", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${localStorage.getItem("token")}`
    },
    body: JSON.stringify(orderData)
  })
    .then(res => res.json())
    .then(data => {
      document.getElementById("orderStatus").textContent = "Order placed successfully!";
      sessionStorage.removeItem("checkoutData");
      setTimeout(() => window.location.href = "orders.html", 2000);
    })
    .catch(err => {
      alert("Order failed. Try again.");
      console.error(err);
    });
}
function placeOrder() {
  const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

  if (paymentMethod === "cod") return placeCODOrder();

  // For UPI/Razorpay payment
  fetch("http://localhost:5000/api/razorpay/order", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ amount: checkoutData.finalAmount })
  })
    .then(res => res.json())
    .then(order => {
      const options = {
        key: "YOUR_PUBLIC_KEY", // Razorpay Key ID
        amount: order.amount,
        currency: "INR",
        name: "Wahu Shop",
        description: "Order Payment",
        order_id: order.id,
        handler: function (response) {
          // Payment Success
          placeCODOrder(response.razorpay_payment_id);
        },
        prefill: {
          name: user.name,
          email: user.email,
          contact: user.address.phone
        },
        theme: { color: "#3399cc" }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    })
    .catch(err => {
      alert("Failed to initiate UPI payment");
      console.error(err);
    });
}



  </script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

</body>
</html>
