<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <title>Profile</title>
  <link rel="stylesheet" href="profile.css" />
</head>

<body>

  <header>
    <div class="logo"><img src="image/WhatsApp Image 2025-07-30 at 22.14.43_da49cc2e.jpg" style="width: 120px; padding-top: 10px; border-radius:5px; padding-left: 20px; height:40px;"></div>
   
  </header>

  <div class="content">
    <main class="form-page">
      <div class="photo"><img src="image/9203764.png" alt="Profile Image"></div>
      <div id="profileInfo"></div>
      <br>

      <a href="address.html" class="btn">Add / Update Address</a>
      <br>
      <a href="orders.html" class="btn"> My Orders</a>
      <button onclick="logout()" style="margin-top: 20px;">Logout</button>

      <br><br>
      
      <h3>Your Wishlist ‚ù§Ô∏è</h3>
<div id="wishlist" class="wishlist-grid"></div>

    </main>
  </div>

  <div class="div2">
    <section class="trending-products">
      <h2>Trending Products</h2>
      <div class="product-grid" id="trending-list">
        <!-- Trending products will load here -->
      </div>

      <div class="div50">
        <h3>Feedback & Information</h3>
        <a href="Conditions.html" style="color:rgb(27, 27, 27)"><h5>Terms and Condition</h5></a>
        <a href="Privacy.html"style="color:rgb(27, 27, 27)"><h5>Privacy Policy</h5></a>
        <a href="Return.html" style="color:rgb(27, 27, 27)"><h5>Return Policy</h5></a>
        <a href="Help.html" style="color:rgb(27, 27, 27)"><h5>Help Center</h5></a>
      </div>
    </section>
  </div>

 <footer>
    <nav class="bottom-nav">
      <a href="index.html" class="nav-item">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="products.html" class="nav-item">
        <i class="fas fa-box-open"></i>
        <span>Products</span>
      </a>
      <a href="cart.html" class="nav-item">
        <i class="fas fa-shopping-cart"></i>
        <span>Cart</span>
      </a>

      <a href="orders.html" class="nav-item">
        <i class="fas fa-receipt"></i>
        <span>Orders</span>
      </a>

      <a href="login.html" class="nav-item" id="userLinks">
        <span id="userLinks">Login </span>
      </a>
    </nav>
  </footer>

  <!-- ‚úÖ Profile Script -->
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const token = localStorage.getItem("token");

      if (!token) {
        alert("‚ö†Ô∏è Please log in first.");
        window.location.href = "login.html";
        return;
      }

     try {
  const res = await fetch("http://localhost:5000/api/users/me", {
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  if (res.status === 401 || res.status === 403) {
    throw new Error("SessionExpired");
  }

  if (!res.ok) {
    throw new Error("FetchFailed");
  }

  // ‚úÖ Safely handle empty or bad JSON
  const text = await res.text();
  if (!text) {
    throw new Error("EmptyResponse");
  }
  const user = JSON.parse(text);

  localStorage.setItem("user", JSON.stringify(user));

  const profileInfo = document.getElementById("profileInfo");
  let addressHTML = "Not provided";

  const a = user.address;
  if (a && typeof a === "object") {
    addressHTML = `
      ${a.name || ""}, ${a.phone || ""}<br>
      ${a.street || ""}, ${a.road || ""}, ${a.place || ""}<br>
      ${a.city || ""}, ${a.state || ""} - ${a.pincode || ""}<br>
      ${a.email || ""}
    `;
  }

  profileInfo.innerHTML = `
    <p><strong>${user.name}</strong></p>
    <p><strong>Email:</strong> ${user.email}</p>
    <p><strong>Address:</strong><br>${addressHTML}</p>
  `;

   // üëâ Load Wishlist
const wishlistContainer = document.getElementById("wishlist");

try {
  const res = await fetch("http://localhost:5000/api/wishlist", {
    headers: {
      Authorization: `Bearer ${token}`
    }
  });

  const data = await res.json();

  if (res.ok && data.items && data.items.length) {
    wishlistContainer.innerHTML = "";
    data.items.forEach(item => {
      const card = document.createElement("div");
      card.className = "wishlist-card";
      card.innerHTML = `
      <div class="wishlist-item">
        <a href="product.html?id=${item.id}">
  <img src="${item.image}" alt="${item.name}" style="height: 100px;
  padding: 10px;
  width: 100px;"/>
  <p style="font-size:12px">${item.name}</p>
  <p style="font-size:12px"><b>‚Çπ${item.price}</b></p>
</a>

        <button onclick="removeFromWishlist('${item.id}')" style="font-size: 12px; width: 100px; padding: 6px 10px; background-color: #ff4d4d; color: white; border: none; border-radius: 4px; cursor: pointer;">
  Remove
</button>

        </div>
      `;

      wishlistContainer.appendChild(card);
    });
  } else {
    wishlistContainer.innerHTML = "<p>No items in wishlist.</p>";
  }
} catch (err) {
  console.error("‚ùå Failed to load wishlist:", err);
  wishlistContainer.innerHTML = "<p>Failed to load wishlist.</p>";
}




  const userLinks = document.getElementById("userLinks");
  userLinks.innerHTML = `
  
    <a href="profile.html"><i class="fas fa-user" style="color:green"></i><br><h5 style="color:white">Profile<h5></a>
    
  `;

} catch (err) {
  console.error("‚ùå Profile load failed:", err);

  if (err.message === "SessionExpired") {
    alert("Session expired. Please log in again.");
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    window.location.href = "login.html";
  } else if (err.message === "EmptyResponse") {
    alert("No user data returned. Please try again.");
  } else {
    alert("Something went wrong. Please try again later.\n" + err.message);
  }
}

    });

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      alert("üëã Logged out");
      window.location.href = "index.html";
    }


async function removeFromWishlist(productId) {
  const token = localStorage.getItem("token");
  if (!token) return;

  try {
    const res = await fetch(`http://localhost:5000/api/wishlist/remove/${productId}`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();

    if (res.ok) {
      alert("‚ùå Removed from Wishlist");
      location.reload(); // refresh to update list
    } else {
      alert("Error: " + data.message);
    }
  } catch (err) {
    console.error("Remove wishlist error:", err);
    alert("Something went wrong.");
  }
}




  </script>

  <!-- ‚úÖ Trending Products Script -->
  <script>
    const trendingList = document.getElementById("trending-list");

    fetch("http://localhost:5000/api/trending")
      .then(res => res.json())
      .then(products => {
        if (!products.length) {
          trendingList.innerHTML = "<p>No trending products found.</p>";
          return;
        }

        trendingList.innerHTML = "";
        products.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          card.innerHTML = `
            <a href="product.html?id=${product._id}">
              <img src="${product.image}" alt="${product.name}" />
              <p>${product.name || "Product"}</p>
            </a>
          `;
          trendingList.appendChild(card);
        });
      })
      .catch(err => {
        console.error("Error loading trending products:", err);
        trendingList.innerHTML = "<p>Error loading trending products.</p>";
      });
  </script>

</body>

</html>
